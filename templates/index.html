<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DART 재무제표 분석</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --apple-blue: #007AFF;
            --apple-gray: #F2F2F7;
            --apple-dark-gray: #8E8E93;
            --apple-light-gray: #F9F9F9;
            --apple-white: #FFFFFF;
            --apple-black: #1D1D1F;
            --apple-green: #30D158;
            --apple-orange: #FF9500;
            --apple-red: #FF3B30;
            --apple-purple: #AF52DE;
            --shadow: rgba(0, 0, 0, 0.1);
            --shadow-light: rgba(0, 0, 0, 0.05);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
            color: var(--apple-black);
            line-height: 1.6;
        }

        /* Header */
        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .logo {
            font-size: 28px;
            font-weight: 700;
            color: var(--apple-black);
            letter-spacing: -0.5px;
        }

        .logo .accent {
            color: var(--apple-blue);
        }

        /* Main Container */
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        /* Search Section */
        .search-section {
            background: var(--apple-white);
            border-radius: 20px;
            padding: 40px;
            margin-bottom: 32px;
            box-shadow: 0 4px 24px var(--shadow-light);
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .search-title {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--apple-black);
        }

        .search-subtitle {
            color: var(--apple-dark-gray);
            margin-bottom: 32px;
            font-size: 16px;
        }

        .search-form {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }

        .input-group {
            position: relative;
            flex: 1;
            min-width: 200px;
        }

        .input-group label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: var(--apple-dark-gray);
            margin-bottom: 8px;
        }

        .input-field, .select-field {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--apple-gray);
            border-radius: 12px;
            font-size: 16px;
            background: var(--apple-white);
            transition: all 0.3s ease;
            outline: none;
        }

        .input-field:focus, .select-field:focus {
            border-color: var(--apple-blue);
            box-shadow: 0 0 0 4px rgba(0, 122, 255, 0.1);
        }

        .company-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--apple-white);
            border: 2px solid var(--apple-gray);
            border-top: none;
            border-radius: 0 0 12px 12px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }

        .company-dropdown.show {
            display: block;
        }

        .company-item {
            padding: 12px 20px;
            cursor: pointer;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            transition: background-color 0.2s ease;
        }

        .company-item:hover {
            background: var(--apple-gray);
        }

        .company-item:last-child {
            border-bottom: none;
        }

        .search-btn {
            background: var(--apple-blue);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 16px 32px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 120px;
            height: fit-content;
            align-self: end;
        }

        .search-btn:hover {
            background: #0056b3;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0, 122, 255, 0.3);
        }

        .search-btn:active {
            transform: translateY(0);
        }

        /* Status Message */
        .status-message {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            font-size: 16px;
            display: none;
        }

        .status-message.info {
            background: rgba(0, 122, 255, 0.1);
            color: var(--apple-blue);
            border: 1px solid rgba(0, 122, 255, 0.2);
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border-color: #c3e6cb;
        }

        .status-message.warning {
            background: #fff3cd;
            color: #856404;
            border-color: #ffeaa7;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border-color: #f5c6cb;
        }

        .status-message.show {
            display: block;
        }

        /* Tab Navigation */
        .tab-navigation {
            background: var(--apple-white);
            border-radius: 16px;
            padding: 8px;
            margin-bottom: 24px;
            display: flex;
            gap: 4px;
            box-shadow: 0 2px 12px var(--shadow-light);
        }

        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: var(--apple-dark-gray);
        }

        .tab-btn.active {
            background: var(--apple-blue);
            color: white;
            box-shadow: 0 2px 8px rgba(0, 122, 255, 0.3);
        }

        /* Statement Navigation */
        .statement-navigation {
            background: var(--apple-white);
            border-radius: 12px;
            padding: 6px;
            margin-bottom: 24px;
            display: flex;
            gap: 3px;
            box-shadow: 0 1px 8px var(--shadow-light);
        }

        .statement-btn {
            flex: 1;
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.3s ease;
            background: transparent;
            color: var(--apple-dark-gray);
        }

        .statement-btn.active {
            background: var(--apple-green);
            color: white;
            box-shadow: 0 1px 4px rgba(48, 209, 88, 0.3);
        }

        /* Content Sections */
        .content-section {
            display: none;
            background: var(--apple-white);
            border-radius: 16px;
            padding: 32px;
            box-shadow: 0 4px 24px var(--shadow-light);
        }

        .content-section.active {
            display: block;
        }

        /* Financial Ratios Summary */
        .financial-summary {
            margin: 32px 0;
            padding: 32px;
            background: var(--apple-white);
            border-radius: 20px;
            box-shadow: 0 4px 24px var(--shadow-light);
        }

        .summary-title {
            font-size: 22px;
            font-weight: 600;
            margin-bottom: 24px;
            color: var(--apple-black);
            text-align: center;
        }

        .ratios-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 24px;
            margin-bottom: 32px;
        }

        .ratio-card {
            background: var(--apple-light-gray);
            border-radius: 16px;
            padding: 24px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .ratio-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px var(--shadow);
        }

        .ratio-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--apple-dark-gray);
            margin-bottom: 8px;
        }

        .ratio-value {
            font-size: 28px;
            font-weight: 700;
            color: var(--apple-blue);
            margin-bottom: 4px;
        }

        .ratio-description {
            font-size: 14px;
            color: var(--apple-dark-gray);
        }

        /* AI Analysis Section - Apple Style */
        .ai-analysis-section {
            margin-top: 32px;
            padding: 0;
            background: transparent;
        }

        .ai-header {
            text-align: center;
            margin-bottom: 32px;
        }

        .ai-title {
            font-size: 32px;
            font-weight: 700;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .ai-subtitle {
            font-size: 18px;
            color: var(--apple-dark-gray);
        }

        .ai-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .ai-btn {
            background: var(--apple-white);
            border: 2px solid var(--apple-gray);
            color: var(--apple-black);
            padding: 32px 24px;
            border-radius: 20px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0.0, 0.2, 1);
            text-align: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 2px 12px var(--shadow-light);
        }

        .ai-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, transparent 0%, rgba(0, 122, 255, 0.05) 100%);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .ai-btn:hover {
            border-color: var(--apple-blue);
            transform: translateY(-4px);
            box-shadow: 0 12px 32px rgba(0, 122, 255, 0.2);
        }

        .ai-btn:hover::before {
            opacity: 1;
        }

        .ai-btn-icon {
            font-size: 32px;
            margin-bottom: 12px;
            display: block;
        }

        .ai-btn-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
            position: relative;
            z-index: 1;
        }

        .ai-btn-desc {
            font-size: 14px;
            color: var(--apple-dark-gray);
            position: relative;
            z-index: 1;
        }

        /* Chart Container */
        .chart-container {
            margin: 24px 0;
            padding: 20px;
            background: var(--apple-light-gray);
            border-radius: 12px;
            height: 400px;
        }

        /* Data Table */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 24px;
            background: var(--apple-white);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 2px 12px var(--shadow-light);
        }

        .data-table th {
            background: var(--apple-gray);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--apple-black);
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
        }

        .data-table td {
            padding: 14px 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .data-table tr:hover {
            background: rgba(0, 122, 255, 0.05);
        }

        /* Loading Animation */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--apple-dark-gray);
        }

        .loading-spinner {
            width: 24px;
            height: 24px;
            border: 3px solid var(--apple-gray);
            border-top: 3px solid var(--apple-blue);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 12px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .container {
                padding: 20px 16px;
            }

            .search-form {
                flex-direction: column;
            }

            .input-group {
                min-width: auto;
            }

            .search-section {
                padding: 24px;
            }

            .content-section {
                padding: 20px;
            }

            .ai-buttons {
                grid-template-columns: 1fr;
            }
        }

        /* AI Analysis Cards */
        .ai-analysis-card {
            background: var(--apple-white);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 12px var(--shadow-light);
            border: 1px solid rgba(0, 0, 0, 0.05);
            transition: all 0.3s ease;
        }

        .ai-analysis-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px var(--shadow-light);
        }

        .ai-card-header {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            gap: 16px;
        }

        .ai-card-icon {
            font-size: 32px;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 12px;
            flex-shrink: 0;
        }

        .ai-card-content {
            flex: 1;
        }

        .ai-card-title {
            font-size: 20px;
            font-weight: 700;
            color: var(--apple-black);
            margin: 0 0 6px 0;
        }

        .ai-card-desc {
            font-size: 14px;
            color: var(--apple-dark-gray);
            margin: 0;
            line-height: 1.4;
        }

        .ai-analyze-btn {
            background: linear-gradient(135deg, var(--apple-blue) 0%, #4dabf7 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 14px 28px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s ease;
            width: 100%;
            justify-content: center;
            margin-bottom: 16px;
        }

        .ai-analyze-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0, 122, 255, 0.3);
        }

        .ai-analyze-btn:active {
            transform: translateY(0);
        }

        .btn-icon {
            font-size: 18px;
        }

        /* Analysis Result */
        .analysis-result {
            margin-top: 20px;
            padding: 20px;
            background: var(--apple-light-gray);
            border-radius: 12px;
            display: none;
            border-left: 4px solid var(--apple-blue);
        }

        .analysis-result.show {
            display: block;
        }

        .analysis-title {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 12px;
            color: var(--apple-black);
        }

        .analysis-content {
            line-height: 1.6;
            color: var(--apple-black);
            white-space: pre-wrap;
            font-size: 14px;
        }

        .analysis-info {
            margin-bottom: 16px;
        }

        .error-message {
            color: var(--apple-red);
        }

        /* 비교 모달 스타일 */
        .comparison-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--apple-white);
            border-radius: 20px;
            max-width: 900px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-header {
            padding: 24px;
            border-bottom: 1px solid var(--apple-gray);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            color: var(--apple-black);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 28px;
            cursor: pointer;
            color: var(--apple-dark-gray);
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--apple-gray);
            color: var(--apple-black);
        }

        .modal-body {
            padding: 24px;
        }

        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 24px;
        }

        .comparison-section {
            background: var(--apple-light-gray);
            padding: 20px;
            border-radius: 12px;
        }

        .comparison-section h4 {
            margin: 0 0 12px 0;
            font-size: 18px;
        }

        .comparison-section p {
            margin: 8px 0;
            font-size: 14px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 16px;
        }

        .comparison-table th,
        .comparison-table td {
            padding: 12px;
            text-align: right;
            border-bottom: 1px solid var(--apple-gray);
        }

        .comparison-table th:first-child,
        .comparison-table td:first-child {
            text-align: left;
        }

        .comparison-table th {
            background: var(--apple-light-gray);
            font-weight: 600;
            color: var(--apple-black);
        }

        .detailed-comparison h4 {
            margin: 0 0 16px 0;
            color: var(--apple-blue);
        }

        /* 비교 버튼 스타일 */
        .compare-btn {
            background: var(--apple-purple);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 12px 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-left: 12px;
        }

        .compare-btn:hover {
            background: #9A44C7;
            transform: translateY(-1px);
        }

        /* 테스트 결과 스타일 */
        .test-section {
            margin-bottom: 24px;
            padding: 16px;
            background: var(--apple-light-gray);
            border-radius: 8px;
        }

        .test-section h4 {
            margin: 0 0 12px 0;
            color: var(--apple-blue);
        }

        .test-section p {
            margin: 8px 0;
            font-size: 14px;
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-content">
            <div class="logo">
                DART <span class="accent">Financial</span>
            </div>
        </div>
    </header>

    <!-- Main Container -->
    <div class="container">
        <!-- Search Section -->
        <section class="search-section">
            <h1 class="search-title">기업 재무제표 분석</h1>
            <p class="search-subtitle">한국 상장기업 재무정보 조회 및 AI 분석</p>
            
            <form class="search-form" id="searchForm">
                <div class="input-group">
                    <label for="companyInput">기업명</label>
                    <input type="text" id="companyInput" class="input-field" placeholder="삼성전자" autocomplete="off">
                    <div class="company-dropdown" id="companyDropdown"></div>
                </div>
                
                <div class="input-group">
                    <label for="yearSelect">사업연도</label>
                    <select id="yearSelect" class="select-field">
                        <option value="2024">2024년</option>
                        <option value="2023">2023년</option>
                        <option value="2022">2022년</option>
                        <option value="2021">2021년</option>
                        <option value="2020">2020년</option>
                    </select>
                </div>
                
                <div class="input-group">
                    <label for="reportSelect">재무제표 유형</label>
                    <select id="reportSelect" class="select-field">
                        <option value="연결재무제표">연결재무제표</option>
                        <option value="별도재무제표">별도재무제표</option>
                    </select>
                </div>
                
                <button type="submit" class="search-btn">조회</button>
            </form>

            <div class="status-message" id="statusMessage"></div>
        </section>

        <!-- Tab Navigation -->
        <nav class="tab-navigation" id="tabNavigation" style="display: none;">
            <button class="tab-btn active" data-tab="quarterly">분기별 분석</button>
            <button class="tab-btn" data-tab="comparison">다년도 비교</button>
            <button class="tab-btn" data-tab="detailed">상세 재무제표</button>
        </nav>

        <!-- Statement Type Navigation -->
        <nav class="statement-navigation" id="statementNavigation" style="display: none;">
            <button class="statement-btn active" data-statement="BS">재무상태표</button>
            <button class="statement-btn" data-statement="IS">포괄손익계산서</button>
            <button class="statement-btn" data-statement="CF">현금흐름표</button>
            <button class="statement-btn" data-statement="SCE">자본변동표</button>
            <button class="compare-btn" onclick="compareFinancialStatements()">
                <span>🔍</span> 별도/연결 비교
            </button>
            <button class="compare-btn" onclick="testFsDifference()" style="background: var(--apple-orange);">
                <span>🧪</span> 차이 테스트
            </button>
        </nav>

        <!-- Content Sections -->
        <section id="quarterlySection" class="content-section active">
            <h2>분기별 재무제표 분석</h2>
            <div class="chart-container">
                <canvas id="quarterlyChart"></canvas>
            </div>
            <div id="quarterlyData"></div>
        </section>

        <section id="comparisonSection" class="content-section">
            <h2>다년도 비교 분석</h2>
            <div class="chart-container">
                <canvas id="comparisonChart"></canvas>
            </div>
            <div id="comparisonData"></div>
        </section>

        <section id="detailedSection" class="content-section">
            <h2>상세 재무제표</h2>
            <div class="chart-container">
                <canvas id="detailedChart"></canvas>
            </div>
            <div id="detailedData"></div>
        </section>

        <!-- Financial Summary Section -->
        <section class="financial-summary" id="financialSummary" style="display: none;">
            <h3 class="summary-title">📊 주요 재무 지표</h3>
            <div class="ratios-grid" id="ratiosGrid">
                <!-- Dynamic content -->
            </div>
        </section>

        <!-- AI Analysis Section -->
        <section class="ai-analysis-section" id="aiAnalysisSection" style="display: none;">
            <div class="ai-header">
                <h3 class="ai-title">AI 재무 분석</h3>
                <p class="ai-subtitle">인공지능이 제공하는 전문적인 재무 분석</p>
            </div>
            
            <!-- 재무비율 분석 카드 -->
            <div class="ai-analysis-card">
                <div class="ai-card-header">
                    <span class="ai-card-icon">📊</span>
                    <div class="ai-card-content">
                        <h4 class="ai-card-title">재무비율 분석</h4>
                        <p class="ai-card-desc">ROE, ROA, 부채비율 등 핵심 재무비율 심층 분석</p>
                    </div>
                </div>
                <button class="ai-analyze-btn" onclick="performAIAnalysis('ratios')">
                    <span class="btn-icon">🔍</span>
                    분석 시작
                </button>
                <div class="analysis-result" id="ratiosAnalysisResult" style="display: none;">
                    <h5 class="analysis-title">재무비율 분석 결과</h5>
                    <div class="analysis-content" id="ratiosAnalysisContent"></div>
                </div>
            </div>

            <!-- 추세 분석 카드 -->
            <div class="ai-analysis-card">
                <div class="ai-card-header">
                    <span class="ai-card-icon">📈</span>
                    <div class="ai-card-content">
                        <h4 class="ai-card-title">추세 분석</h4>
                        <p class="ai-card-desc">시계열 데이터 기반 성장 패턴 및 트렌드 분석</p>
                    </div>
                </div>
                <button class="ai-analyze-btn" onclick="performAIAnalysis('trends')">
                    <span class="btn-icon">📊</span>
                    분석 시작
                </button>
                <div class="analysis-result" id="trendsAnalysisResult" style="display: none;">
                    <h5 class="analysis-title">추세 분석 결과</h5>
                    <div class="analysis-content" id="trendsAnalysisContent"></div>
                </div>
            </div>

            <!-- 투자 분석 카드 -->
            <div class="ai-analysis-card">
                <div class="ai-card-header">
                    <span class="ai-card-icon">💎</span>
                    <div class="ai-card-content">
                        <h4 class="ai-card-title">투자 분석</h4>
                        <p class="ai-card-desc">투자 가치 평가 및 투자 매력도 종합 분석</p>
                    </div>
                </div>
                <button class="ai-analyze-btn" onclick="performAIAnalysis('investment')">
                    <span class="btn-icon">💰</span>
                    분석 시작
                </button>
                <div class="analysis-result" id="investmentAnalysisResult" style="display: none;">
                    <h5 class="analysis-title">투자 분석 결과</h5>
                    <div class="analysis-content" id="investmentAnalysisContent"></div>
                </div>
            </div>

            <!-- 종합 분석 카드 -->
            <div class="ai-analysis-card">
                <div class="ai-card-header">
                    <span class="ai-card-icon">🎯</span>
                    <div class="ai-card-content">
                        <h4 class="ai-card-title">종합 분석</h4>
                        <p class="ai-card-desc">전체적인 재무 상태 및 경영 성과 종합 평가</p>
                    </div>
                </div>
                <button class="ai-analyze-btn" onclick="performAIAnalysis('comprehensive')">
                    <span class="btn-icon">🧠</span>
                    분석 시작
                </button>
                <div class="analysis-result" id="comprehensiveAnalysisResult" style="display: none;">
                    <h5 class="analysis-title">종합 분석 결과</h5>
                    <div class="analysis-content" id="comprehensiveAnalysisContent"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        // 전역 변수
        let currentCorpCode = '';
        let currentCorpName = '';
        let currentYear = '2024';
        let currentFsDiv = 'CFS';
        let currentStatementType = 'BS'; // 현재 재무제표 유형
        let quarterlyChartInstance = null;
        let comparisonChartInstance = null;
        let detailedChartInstance = null;

        // DOM 요소
        const companyInput = document.getElementById('companyInput');
        const companyDropdown = document.getElementById('companyDropdown');
        const yearSelect = document.getElementById('yearSelect');
        const reportSelect = document.getElementById('reportSelect');
        const searchForm = document.getElementById('searchForm');
        const statusMessage = document.getElementById('statusMessage');
        const tabNavigation = document.getElementById('tabNavigation');
        const statementNavigation = document.getElementById('statementNavigation');
        const aiAnalysisSection = document.getElementById('aiAnalysisSection');

        // 초기화
        document.addEventListener('DOMContentLoaded', function() {
            setupEventListeners();
            updateYearOptions();
        });

        // 이벤트 리스너 설정
        function setupEventListeners() {
            // 회사명 입력 이벤트
            companyInput.addEventListener('input', handleCompanyInput);
            companyInput.addEventListener('blur', () => {
                setTimeout(() => companyDropdown.classList.remove('show'), 200);
            });

            // 폼 제출 이벤트
            searchForm.addEventListener('submit', handleFormSubmit);

            // 탭 클릭 이벤트
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tab = btn.getAttribute('data-tab');
                    switchTab(tab);
                });
            });

            // 재무제표 유형 클릭 이벤트
            document.querySelectorAll('.statement-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const statementType = btn.getAttribute('data-statement');
                    switchStatementType(statementType);
                });
            });

            // 문서 클릭 이벤트 (드롭다운 닫기)
            document.addEventListener('click', (e) => {
                if (!companyInput.contains(e.target) && !companyDropdown.contains(e.target)) {
                    companyDropdown.classList.remove('show');
                }
            });
        }

        // 연도 옵션 업데이트
        function updateYearOptions() {
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = '';
            
            for (let year = currentYear; year >= currentYear - 10; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = `${year}년`;
                yearSelect.appendChild(option);
            }
        }

        // 회사명 입력 처리
        function handleCompanyInput(e) {
            const query = e.target.value.trim();
            
            if (query.length >= 2) {
                searchCompanies(query);
            } else {
                companyDropdown.classList.remove('show');
            }
        }

        // 회사 검색
        async function searchCompanies(query) {
            try {
                const response = await fetch(`/api/search_corp?name=${encodeURIComponent(query)}`);
                const data = await response.json();
                
                if (data.success && data.results && data.results.length > 0) {
                    displayCompanyDropdown(data.results);
                } else {
                    companyDropdown.classList.remove('show');
                }
            } catch (error) {
                console.error('회사 검색 오류:', error);
                companyDropdown.classList.remove('show');
            }
        }

        // 회사 드롭다운 표시
        function displayCompanyDropdown(companies) {
            companyDropdown.innerHTML = '';
            
            companies.forEach(company => {
                const item = document.createElement('div');
                item.className = 'company-item';
                item.textContent = company.corp_name;
                item.addEventListener('click', () => {
                    selectCompany(company);
                });
                companyDropdown.appendChild(item);
            });
            
            companyDropdown.classList.add('show');
        }

        // 회사 선택
        function selectCompany(company) {
            // 기존 분석 결과 모두 초기화
            clearAllAnalysisResults();
            
            // 이전 기업 정보 로그
            console.log(`🔄 기업 변경: ${currentCorpName || '없음'} → ${company.corp_name}`);
            
            companyInput.value = company.corp_name;
            currentCorpCode = company.corp_code;
            currentCorpName = company.corp_name;
            companyDropdown.classList.remove('show');
            
            // AI 분석 섹션과 재무지표 요약 숨김 (새로 조회할 때까지)
            const aiAnalysisSection = document.getElementById('aiAnalysisSection');
            const financialSummary = document.getElementById('financialSummary');
            
            if (aiAnalysisSection) {
                aiAnalysisSection.style.display = 'none';
            }
            if (financialSummary) {
                financialSummary.style.display = 'none';
            }
            
            console.log(`✅ 새 기업 선택 완료: ${currentCorpName} (${currentCorpCode})`);
        }

        // 폼 제출 처리
        function handleFormSubmit(e) {
            e.preventDefault();
            
            if (!currentCorpCode || !currentCorpName) {
                showMessage('기업을 선택해주세요.', 'error');
                return;
            }
            
            currentYear = yearSelect.value;
            currentFsDiv = reportSelect.value === '연결재무제표' ? 'CFS' : 'OFS';
            
            // 현재 선택된 정보 표시
            const fsTypeText = currentFsDiv === 'CFS' ? '연결재무제표' : '별도재무제표';
            showMessage(`${currentCorpName} ${currentYear}년 ${fsTypeText} 데이터를 조회하고 있습니다...`, 'info');
            
            // 기존 AI 분석 결과 모두 초기화
            clearAllAnalysisResults();
            
            // 탭 네비게이션 표시
            tabNavigation.style.display = 'flex';
            statementNavigation.style.display = 'flex';
            document.getElementById('financialSummary').style.display = 'block';
            aiAnalysisSection.style.display = 'block';
            
            // AI 분석 섹션 제목 강제 업데이트
            forceUpdateAIAnalysisSection();
            
            // 현재 활성 탭에 따라 데이터 로드
            const activeTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');
            loadDataForTab(activeTab);
        }

        // 모든 AI 분석 결과 초기화
        function clearAllAnalysisResults() {
            const analysisTypes = ['ratios', 'trends', 'investment', 'comprehensive'];
            analysisTypes.forEach(type => {
                const resultDiv = document.getElementById(`${type}AnalysisResult`);
                if (resultDiv) {
                    resultDiv.style.display = 'none';
                    const contentDiv = document.getElementById(`${type}AnalysisContent`);
                    if (contentDiv) {
                        contentDiv.innerHTML = '';
                    }
                }
            });
        }

        // AI 분석 섹션 강제 업데이트
        function forceUpdateAIAnalysisSection() {
            const fsTypeText = currentFsDiv === 'CFS' ? '연결재무제표' : '별도재무제표';
            
            // AI 분석 섹션 제목 업데이트
            const aiSectionTitle = document.querySelector('#aiAnalysisSection .ai-title');
            if (aiSectionTitle) {
                aiSectionTitle.textContent = `🤖 AI 재무분석 - ${currentCorpName} (${currentYear}년 ${fsTypeText})`;
            }
            
            // 재무지표 요약 섹션 초기화
            const financialSummary = document.getElementById('financialSummary');
            if (financialSummary) {
                financialSummary.innerHTML = `
                    <h3>📊 재무지표 요약 - ${currentCorpName} (${currentYear}년 ${fsTypeText})</h3>
                    <div class="summary-grid">
                        <div class="loading">데이터를 불러오는 중...</div>
                    </div>
                `;
            }
            
            console.log(`✅ AI 섹션 업데이트 완료: ${currentCorpName}`);
        }

        // 탭 전환
        function switchTab(tab) {
            // 탭 버튼 활성화
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            
            // 콘텐츠 섹션 표시
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            document.getElementById(`${tab}Section`).classList.add('active');
            
            // 데이터 로드
            loadDataForTab(tab);
        }

        // 재무제표 유형 전환
        function switchStatementType(statementType) {
            // 버튼 활성화
            document.querySelectorAll('.statement-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-statement="${statementType}"]`).classList.add('active');
            
            // 현재 재무제표 유형 업데이트
            currentStatementType = statementType;
            
            const fsTypeText = currentFsDiv === 'CFS' ? '연결재무제표' : '별도재무제표';
            showMessage(`${currentCorpName} ${statementType} ${fsTypeText} 데이터를 조회합니다...`, 'info');
            
            // AI 분석 섹션 제목 다시 업데이트
            forceUpdateAIAnalysisSection();
            
            // 현재 활성 탭에 따라 데이터 다시 로드
            const activeTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');
            loadDataForTab(activeTab);
        }

        // 탭별 데이터 로드
        async function loadDataForTab(tab) {
            switch (tab) {
                case 'quarterly':
                    await loadQuarterlyData();
                    break;
                case 'comparison':
                    await loadComparisonData();
                    break;
                case 'detailed':
                    await loadDetailedData();
                    break;
            }
            
            // 재무지표 요약 로드
            await loadFinancialSummary();
        }

        // 재무지표 요약 로드
        async function loadFinancialSummary() {
            try {
                const fsTypeText = currentFsDiv === 'CFS' ? '연결재무제표' : '별도재무제표';
                console.log(`재무지표 요약 로드: ${currentCorpName} ${currentYear}년 ${fsTypeText}`);
                
                // BS, IS, CF 데이터를 모두 가져와서 주요 지표 계산
                const [bsResponse, isResponse, cfResponse] = await Promise.all([
                    fetch(`/api/financial/BS?corp_code=${currentCorpCode}&year=${currentYear}&fs_div=${currentFsDiv}`),
                    fetch(`/api/financial/IS?corp_code=${currentCorpCode}&year=${currentYear}&fs_div=${currentFsDiv}`),
                    fetch(`/api/financial/CF?corp_code=${currentCorpCode}&year=${currentYear}&fs_div=${currentFsDiv}`)
                ]);

                const [bsData, isData, cfData] = await Promise.all([
                    bsResponse.json(),
                    isResponse.json(),
                    cfResponse.json()
                ]);

                if (bsData.success || isData.success || cfData.success) {
                    displayFinancialSummary(bsData, isData, cfData);
                } else {
                    document.getElementById('financialSummary').innerHTML = `
                        <div class="error-message">
                            <h3>📊 재무지표 요약</h3>
                            <p>재무데이터를 불러올 수 없습니다.</p>
                            <p><em>${currentCorpName} ${currentYear}년 ${fsTypeText}</em></p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('재무지표 요약 로드 오류:', error);
                document.getElementById('financialSummary').innerHTML = `
                    <div class="error-message">
                        <h3>📊 재무지표 요약</h3>
                        <p>오류가 발생했습니다: ${error.message}</p>
                    </div>
                `;
            }
        }

        // 재무지표 요약 표시
        function displayFinancialSummary(bsData, isData, cfData) {
            const fsTypeText = currentFsDiv === 'CFS' ? '연결재무제표' : '별도재무제표';
            
            // 현재 기업명 강제 확인
            console.log(`💼 재무지표 요약 표시 - 현재 기업: ${currentCorpName}`);
            
            let summaryHtml = `
                <h3>📊 재무지표 요약 - ${currentCorpName} (${currentYear}년 ${fsTypeText})</h3>
                <div class="summary-grid">
            `;

            // 주요 재무지표 계산 및 표시
            if (bsData.success && bsData.data) {
                const totalAssets = getAccountValue(bsData.data, ['자산총계', '자산총액']);
                const totalLiabilities = getAccountValue(bsData.data, ['부채총계', '부채총액']);
                const totalEquity = getAccountValue(bsData.data, ['자본총계', '자본총액']);
                
                summaryHtml += `
                    <div class="summary-item">
                        <h4>재무상태 (단위: 억원)</h4>
                        <p><strong>${currentCorpName}</strong></p>
                        <p>총자산: ${formatAmount(totalAssets)}</p>
                        <p>총부채: ${formatAmount(totalLiabilities)}</p>
                        <p>총자본: ${formatAmount(totalEquity)}</p>
                        <p><small>${fsTypeText} 기준</small></p>
                    </div>
                `;
            }

            if (isData.success && isData.data) {
                const revenue = getAccountValue(isData.data, ['매출액', '수익(매출액)']);
                const operatingProfit = getAccountValue(isData.data, ['영업이익', '영업이익(손실)']);
                const netIncome = getAccountValue(isData.data, ['당기순이익', '당기순이익(손실)']);
                
                summaryHtml += `
                    <div class="summary-item">
                        <h4>경영성과 (단위: 억원)</h4>
                        <p><strong>${currentCorpName}</strong></p>
                        <p>매출액: ${formatAmount(revenue)}</p>
                        <p>영업이익: ${formatAmount(operatingProfit)}</p>
                        <p>당기순이익: ${formatAmount(netIncome)}</p>
                        <p><small>${fsTypeText} 기준</small></p>
                    </div>
                `;
            }

            // 데이터가 없는 경우 기본 표시
            if (!bsData.success && !isData.success) {
                summaryHtml += `
                    <div class="summary-item">
                        <h4>${currentCorpName} 재무데이터</h4>
                        <p>해당 연도의 재무데이터를 찾을 수 없습니다.</p>
                        <p><small>${currentYear}년 ${fsTypeText}</small></p>
                    </div>
                `;
            }

            summaryHtml += '</div>';
            document.getElementById('financialSummary').innerHTML = summaryHtml;
            
            console.log(`✅ 재무지표 요약 업데이트 완료: ${currentCorpName}`);
        }

        // 계정값 추출 도우미 함수
        function getAccountValue(data, accountNames) {
            for (const accountName of accountNames) {
                for (const [key, value] of Object.entries(data)) {
                    if (key.includes(accountName)) {
                        return Math.abs(parseInt(value)) || 0;
                    }
                }
            }
            return 0;
        }

        // 분기별 데이터 로드
        async function loadQuarterlyData() {
            try {
                showLoading('quarterlyData');
                
                const response = await fetch(`/api/quarterly/${currentStatementType}?corp_code=${currentCorpCode}&year=${currentYear}&fs_div=${currentFsDiv}`);
                const data = await response.json();
                
                if (data.success) {
                    displayQuarterlyChart(data.data);
                    displayQuarterlyTable(data.data);
                    showMessage('분기별 데이터를 성공적으로 로드했습니다.', 'info');
                } else {
                    throw new Error(data.error || '데이터 로드 실패');
                }
            } catch (error) {
                console.error('분기별 데이터 로드 오류:', error);
                showMessage(`데이터 로드 오류: ${error.message}`, 'error');
            }
        }

        // 다년도 비교 데이터 로드
        async function loadComparisonData() {
            try {
                showLoading('comparisonData');
                
                const response = await fetch(`/api/compare/multi-year?corp_code=${currentCorpCode}&years=${currentYear},${parseInt(currentYear)-1},${parseInt(currentYear)-2}&sj_div=${currentStatementType}&fs_div=${currentFsDiv}`);
                const data = await response.json();
                
                if (data.success) {
                    displayComparisonChart(data.data);
                    displayComparisonTable(data.data);
                    showMessage('다년도 비교 데이터를 성공적으로 로드했습니다.', 'info');
                } else {
                    throw new Error(data.error || '데이터 로드 실패');
                }
            } catch (error) {
                console.error('다년도 비교 데이터 로드 오류:', error);
                showMessage(`데이터 로드 오류: ${error.message}`, 'error');
            }
        }

        // 상세 재무제표 데이터 로드
        async function loadDetailedData() {
            try {
                showLoading('detailedData');
                
                const response = await fetch(`/api/financial/${currentStatementType}?corp_code=${currentCorpCode}&year=${currentYear}&fs_div=${currentFsDiv}`);
                const data = await response.json();
                
                if (data.success) {
                    displayDetailedChart(data.data);
                    displayDetailedTable(data.data);
                    showMessage('상세 재무제표를 성공적으로 로드했습니다.', 'info');
                } else {
                    throw new Error(data.error || '데이터 로드 실패');
                }
            } catch (error) {
                console.error('상세 재무제표 로드 오류:', error);
                showMessage(`데이터 로드 오류: ${error.message}`, 'error');
            }
        }

        // 분기별 차트 표시
        function displayQuarterlyChart(data) {
            const ctx = document.getElementById('quarterlyChart').getContext('2d');
            
            if (quarterlyChartInstance) {
                quarterlyChartInstance.destroy();
            }
            
            const labels = Object.keys(data);
            const datasets = [];
            
            // 재무제표 유형에 따른 주요 계정과목들 추출
            let mainAccounts = [];
            let colors = [];
            
            if (currentStatementType === 'BS') {
                mainAccounts = ['자산총계', '부채총계', '자본총계'];
                colors = ['#007AFF', '#30D158', '#FF9500'];
            } else if (currentStatementType === 'IS') {
                mainAccounts = ['매출액', '영업이익', '당기순이익'];
                colors = ['#007AFF', '#30D158', '#FF3B30'];
            } else if (currentStatementType === 'CF') {
                mainAccounts = ['영업활동현금흐름', '투자활동현금흐름', '재무활동현금흐름'];
                colors = ['#007AFF', '#30D158', '#FF9500'];
            } else if (currentStatementType === 'SCE') {
                mainAccounts = ['자본금', '이익잉여금', '자본총계'];
                colors = ['#007AFF', '#30D158', '#FF9500'];
            } else {
                // 기본값 (혼합)
                mainAccounts = ['자산총계', '부채총계', '자본총계', '매출액', '영업이익', '당기순이익'];
                colors = ['#007AFF', '#30D158', '#FF9500', '#AF52DE', '#FF6B35', '#FF3B30'];
            }
            
            mainAccounts.forEach((account, index) => {
                const accountData = labels.map(quarter => {
                    const quarterData = data[quarter];
                    // 정확한 계정명이 없으면 비슷한 이름 찾기
                    let value = quarterData[account];
                    if (!value) {
                        // 계정명에 포함된 키워드로 검색
                        for (const [key, val] of Object.entries(quarterData)) {
                            if (key.includes(account) || account.includes(key.split(' ')[0])) {
                                value = val;
                                break;
                            }
                        }
                    }
                    return value ? value / 100000000 : 0; // 억 단위
                });
                
                if (accountData.some(value => value > 0)) {
                    datasets.push({
                        label: account,
                        data: accountData,
                        borderColor: colors[index],
                        backgroundColor: colors[index] + '20',
                        borderWidth: 3,
                        fill: false,
                        tension: 0.4
                    });
                }
            });
            
            quarterlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                            labels: {
                                usePointStyle: true,
                                padding: 20
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}억원`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '금액 (억원)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return `${value.toLocaleString()}억`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 다년도 비교 차트 표시
        function displayComparisonChart(data) {
            const ctx = document.getElementById('comparisonChart').getContext('2d');
            
            if (comparisonChartInstance) {
                comparisonChartInstance.destroy();
            }
            
            const years = Object.keys(data);
            
            // 재무제표 유형에 따른 주요 계정과목들 추출
            let mainAccounts = [];
            let colors = [];
            
            if (currentStatementType === 'BS') {
                mainAccounts = ['자산총계', '부채총계', '자본총계'];
                colors = ['#007AFF', '#30D158', '#FF9500'];
            } else if (currentStatementType === 'IS') {
                mainAccounts = ['매출액', '영업이익', '당기순이익'];
                colors = ['#007AFF', '#30D158', '#FF3B30'];
            } else if (currentStatementType === 'CF') {
                mainAccounts = ['영업활동현금흐름', '투자활동현금흐름', '재무활동현금흐름'];
                colors = ['#007AFF', '#30D158', '#FF9500'];
            } else if (currentStatementType === 'SCE') {
                mainAccounts = ['자본금', '이익잉여금', '자본총계'];
                colors = ['#007AFF', '#30D158', '#FF9500'];
            } else {
                // 기본값
                mainAccounts = ['자산총계', '부채총계', '자본총계'];
                colors = ['#007AFF', '#30D158', '#FF9500'];
            }
            
            const datasets = mainAccounts.map((account, index) => ({
                label: account,
                data: years.map(year => {
                    const yearData = data[year];
                    // 정확한 계정명이 없으면 비슷한 이름 찾기
                    let value = yearData[account];
                    if (!value) {
                        // 계정명에 포함된 키워드로 검색
                        for (const [key, val] of Object.entries(yearData)) {
                            if (key.includes(account) || account.includes(key.split(' ')[0])) {
                                value = val;
                                break;
                            }
                        }
                    }
                    return value ? value / 100000000 : 0; // 억 단위
                }),
                backgroundColor: colors[index],
                borderColor: colors[index],
                borderWidth: 2
            }));
            
            comparisonChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: years, datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.dataset.label}: ${context.parsed.y.toLocaleString()}억원`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '금액 (억원)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return `${value.toLocaleString()}억`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 상세 차트 표시 (계층형 바 차트)
        function displayDetailedChart(data) {
            const ctx = document.getElementById('detailedChart').getContext('2d');
            
            if (detailedChartInstance) {
                detailedChartInstance.destroy();
            }
            
            let categories = {};
            let colorSchemes = {};
            
            // 재무제표 유형에 따른 분류
            if (currentStatementType === 'BS') {
                categories = {
                    '자산': [],
                    '부채': [],
                    '자본': []
                };
                colorSchemes = {
                    '자산': '#007AFF',
                    '부채': '#FF9500', 
                    '자본': '#30D158'
                };
                
                // 계정과목 분류
                                Object.entries(data).forEach(([account, value]) => {
                    if (account.includes('자산') && !account.includes('부채') && !account.includes('자본')) {
                        categories['자산'].push({ account, value: Math.abs(value) });
                    } else if (account.includes('부채')) {
                        categories['부채'].push({ account, value: Math.abs(value) });
                    } else if (account.includes('자본')) {
                        categories['자본'].push({ account, value: Math.abs(value) });
                    }
                });
            } else if (currentStatementType === 'IS') {
                categories = {
                    '수익': [],
                    '비용': [],
                    '이익': []
                };
                colorSchemes = {
                    '수익': '#007AFF',
                    '비용': '#FF9500',
                    '이익': '#30D158'
                };
                
                Object.entries(data).forEach(([account, value]) => {
                    if (account.includes('매출') || account.includes('수익')) {
                        categories['수익'].push({ account, value: Math.abs(value) });
                    } else if (account.includes('비용') || account.includes('원가')) {
                        categories['비용'].push({ account, value: Math.abs(value) });
                    } else if (account.includes('이익') || account.includes('손실')) {
                        categories['이익'].push({ account, value: Math.abs(value) });
                    }
                });
            } else if (currentStatementType === 'CF') {
                categories = {
                    '영업활동': [],
                    '투자활동': [],
                    '재무활동': []
                };
                colorSchemes = {
                    '영업활동': '#007AFF',
                    '투자활동': '#FF9500',
                    '재무활동': '#30D158'
                };
                
                Object.entries(data).forEach(([account, value]) => {
                    if (account.includes('영업활동')) {
                        categories['영업활동'].push({ account, value: Math.abs(value) });
                    } else if (account.includes('투자활동')) {
                        categories['투자활동'].push({ account, value: Math.abs(value) });
                    } else if (account.includes('재무활동')) {
                        categories['재무활동'].push({ account, value: Math.abs(value) });
                    }
                });
            } else if (currentStatementType === 'SCE') {
                categories = {
                    '자본금': [],
                    '잉여금': [],
                    '기타': []
                };
                colorSchemes = {
                    '자본금': '#007AFF',
                    '잉여금': '#FF9500',
                    '기타': '#30D158'
                };
                
                Object.entries(data).forEach(([account, value]) => {
                    if (account.includes('자본금')) {
                        categories['자본금'].push({ account, value: Math.abs(value) });
                    } else if (account.includes('잉여금')) {
                        categories['잉여금'].push({ account, value: Math.abs(value) });
                    } else {
                        categories['기타'].push({ account, value: Math.abs(value) });
                    }
                });
            }
            
            // 각 카테고리별 상위 5개씩 선택
            const labels = [];
            const values = [];
                        const backgroundColors = [];
            
            Object.entries(categories).forEach(([category, items]) => {
                items.sort((a, b) => b.value - a.value)
                     .slice(0, 5)
                     .forEach(item => {
                         labels.push(item.account);
                         values.push(item.value / 100000000); // 억 단위
                         backgroundColors.push(colorSchemes[category]);
                     });
            });
            
            detailedChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels,
                    datasets: [{
                        label: '금액 (억원)',
                        data: values,
                        backgroundColor: backgroundColors,
                        borderWidth: 0,
                        borderRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.parsed.x.toLocaleString()}억원`;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '금액 (억원)'
                            },
                            ticks: {
                                callback: function(value) {
                                    return `${value.toLocaleString()}억`;
                                }
                            }
                        },
                        y: {
                            ticks: {
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        // 테이블 표시 함수들
        function displayQuarterlyTable(data) {
            const container = document.getElementById('quarterlyData');
            container.innerHTML = createDataTable(data, '분기별');
        }

        function displayComparisonTable(data) {
            const container = document.getElementById('comparisonData');
            container.innerHTML = createDataTable(data, '연도별');
        }

        function displayDetailedTable(data) {
            const container = document.getElementById('detailedData');
            const tableData = { [currentYear]: data };
            container.innerHTML = createDataTable(tableData, '계정과목별');
        }

        // 데이터 테이블 생성
        function createDataTable(data, type) {
            const periods = Object.keys(data);
            const allAccounts = new Set();
            
            // 모든 계정과목 수집
            periods.forEach(period => {
                Object.keys(data[period]).forEach(account => {
                    allAccounts.add(account);
                });
            });
            
            let html = `<table class="data-table">`;
            html += `<thead><tr><th>계정과목</th>`;
            periods.forEach(period => {
                html += `<th>${period}</th>`;
            });
            html += `</tr></thead><tbody>`;
            
            Array.from(allAccounts).forEach(account => {
                html += `<tr><td>${account}</td>`;
                periods.forEach(period => {
                    const value = data[period][account] || 0;
                    html += `<td>${formatNumber(value / 1000000)}백만원</td>`;
                });
                html += `</tr>`;
            });
            
            html += `</tbody></table>`;
            return html;
        }

        // AI 분석 수행
        async function performAIAnalysis(type) {
            try {
                // 현재 설정 검증
                if (!currentCorpName || !currentCorpCode) {
                    showMessage('기업을 먼저 선택해주세요.', 'error');
                    return;
                }
                
                // 각 분석 유형별로 개별 결과 영역 사용
                const analysisTitle = document.getElementById(`${type}AnalysisResult`).querySelector('.analysis-title');
                const analysisContent = document.getElementById(`${type}AnalysisContent`);
                const analysisResult = document.getElementById(`${type}AnalysisResult`);
                
                const fsTypeText = currentFsDiv === 'CFS' ? '연결재무제표' : '별도재무제표';
                
                // 콘솔에 현재 상태 출력 (디버깅용)
                console.log(`🔍 AI 분석 요청 정보:`);
                console.log(`   - 기업명: ${currentCorpName}`);
                console.log(`   - 기업코드: ${currentCorpCode}`);
                console.log(`   - 연도: ${currentYear}`);
                console.log(`   - 재무제표구분: ${currentFsDiv} (${fsTypeText})`);
                console.log(`   - 분석타입: ${type}`);
                
                analysisTitle.textContent = `${getAnalysisTypeTitle(type)} 진행 중...`;
                analysisContent.innerHTML = `
                    <div class="analysis-info">
                        <p><strong>분석 대상:</strong> ${currentCorpName}</p>
                        <p><strong>기준 연도:</strong> ${currentYear}년</p>
                        <p><strong>재무제표 구분:</strong> ${fsTypeText}</p>
                        <p><em>AI가 "${currentCorpName}"의 재무데이터를 분석하고 있습니다...</em></p>
                    </div>
                `;
                analysisResult.style.display = 'block';
                
                // 현재 활성 탭의 데이터 가져오기
                const activeTab = document.querySelector('.tab-btn.active').getAttribute('data-tab');
                const financialData = await getCurrentFinancialData(activeTab);
                
                // 구체적인 프롬프트 생성
                const prompt = getAnalysisPrompt(type);
                
                // 서버로 전송할 데이터 구성
                const requestData = {
                    corp_name: currentCorpName,  // 현재 선택된 기업명
                    year: currentYear,
                    financial_data: financialData,
                    prompt: prompt,
                    fs_div: currentFsDiv,  // 재무제표 구분 추가
                    corp_code: currentCorpCode  // 기업코드도 추가
                };
                
                console.log('📤 서버로 전송하는 데이터:', requestData);
                
                const response = await fetch(`/api/ai-analysis/${type}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });
                
                const data = await response.json();
                console.log('📥 서버 응답:', data);
                
                if (data.success) {
                    analysisTitle.textContent = `${getAnalysisTypeTitle(type)} - ${currentCorpName} (${currentYear}년 ${fsTypeText})`;
                    // 종합 분석의 경우 객체 형태로 올 수 있음
                    if (typeof data.analysis === 'object' && data.analysis.comprehensive) {
                        analysisContent.innerHTML = `<pre style="white-space: pre-wrap; font-family: inherit;">${data.analysis.comprehensive}</pre>`;
                    } else if (typeof data.analysis === 'string') {
                        analysisContent.innerHTML = `<pre style="white-space: pre-wrap; font-family: inherit;">${data.analysis}</pre>`;
                    } else {
                        analysisContent.innerHTML = `<pre style="white-space: pre-wrap; font-family: inherit;">${JSON.stringify(data.analysis, null, 2)}</pre>`;
                    }
                    
                    // 성공 메시지
                    showMessage(`${currentCorpName} AI 분석이 완료되었습니다!`, 'success');
                } else {
                    throw new Error(data.error || 'AI 분석 실패');
                }
            } catch (error) {
                console.error('AI 분석 오류:', error);
                const analysisTitle = document.getElementById(`${type}AnalysisResult`).querySelector('.analysis-title');
                const analysisContent = document.getElementById(`${type}AnalysisContent`);
                
                analysisTitle.textContent = 'AI 분석 오류';
                analysisContent.innerHTML = `
                    <div class="error-message">
                        <p><strong>분석 중 오류가 발생했습니다:</strong></p>
                        <p>${error.message}</p>
                        <p><strong>현재 설정:</strong></p>
                        <p>기업명: ${currentCorpName || '선택되지 않음'}</p>
                        <p>연도: ${currentYear}</p>
                        <p><em>다시 시도해주세요.</em></p>
                    </div>
                `;
                
                showMessage(`AI 분석 오류: ${error.message}`, 'error');
            }
        }

        // 분석 유형별 구체적인 프롬프트 생성
        function getAnalysisPrompt(type) {
            const prompts = {
                'ratios': `
다음 재무데이터를 바탕으로 종합적인 재무비율 분석을 수행해주세요:

1. 수익성 지표 분석
   - ROE (자기자본이익률): 자기자본 대비 수익성 평가
   - ROA (총자산이익률): 자산 활용 효율성 평가
   - 영업이익률, 순이익률: 수익 창출 능력 평가

2. 안정성 지표 분석
   - 부채비율: 재무구조의 안정성 평가
   - 자기자본비율: 자본 구조의 건전성 평가
   - 유동비율: 단기 지급능력 평가

3. 성장성 지표 분석
   - 매출액 규모와 성장 잠재력
   - 자산 규모와 성장성

각 비율의 의미와 업계 평균 대비 수준을 평가하고, 투자자 관점에서의 시사점을 제시해주세요.
                `,
                'trends': `
제공된 시계열 재무데이터를 바탕으로 다음 추세 분석을 수행해주세요:

1. 매출 성장 추세 분석
   - 연도별/분기별 매출 증감률 계산
   - 성장 패턴 및 계절성 분석
   - 향후 성장 전망

2. 수익성 변화 추세
   - 영업이익, 순이익의 변화 패턴
   - 수익성 개선/악화 요인 분석
   - 마진율 변화 추이

3. 재무구조 변화 분석
   - 자산, 부채, 자본의 변화 추이
   - 재무건전성 개선/악화 여부
   - 투자 활동과 재무 전략 변화

각 추세의 의미를 분석하고, 향후 전망에 대한 인사이트를 제공해주세요.
                `,
                'investment': `
투자자 관점에서 다음 사항들을 종합적으로 분석하여 투자 매력도를 평가해주세요:

1. 투자 가치 평가
   - 기업의 내재가치 대비 현재 상황
   - 성장성과 수익성의 균형
   - 배당 정책 및 주주 환원 정책

2. 투자 리스크 분석
   - 재무적 리스크 (부채 수준, 유동성)
   - 사업적 리스크 (수익 변동성, 시장 의존도)
   - 거시경제적 리스크 요인

3. 투자 추천 의견
   - 장기/단기 투자 관점별 평가
   - 목표주가 또는 기업가치 평가
   - 투자 시점과 전략 제안

포트폴리오 관점에서의 위치와 역할도 함께 분석해주세요.
                `,
                'comprehensive': `
제공된 재무데이터를 바탕으로 기업에 대한 종합적인 분석을 수행해주세요:

1. 기업 개요 및 사업 현황
   - 재무데이터로 파악되는 사업 규모와 특성
   - 시장 지위 및 경쟁력 추정

2. 재무 건전성 종합 평가
   - 수익성, 안정성, 성장성의 종합 점수
   - 각 영역별 강점과 약점 분석
   - 동종업계 대비 상대적 위치

3. 경영 성과 및 전략 평가
   - 경영진의 재무 관리 능력
   - 자본 배분 효율성
   - 미래 성장 전략의 타당성

4. 종합 의견 및 결론
   - SWOT 분석 형태의 종합 평가
   - 주요 관심 포인트 및 모니터링 지표
   - 장기적 관점에서의 기업 전망

모든 분석은 구체적인 수치와 근거를 바탕으로 제시해주세요.
                `
            };
            return prompts[type] || '';
        }

        // 분석 유형 제목 반환
        function getAnalysisTypeTitle(type) {
            const titles = {
                'ratios': '📊 재무비율 분석',
                'trends': '📈 추세 분석',
                'investment': '💎 투자 분석',
                'comprehensive': '🎯 종합 분석'
            };
            return titles[type] || '분석 결과';
        }

        // 현재 재무데이터 가져오기
        async function getCurrentFinancialData(tab) {
            try {
                // 실제 재무데이터를 API에서 가져오기
                const [bsResponse, isResponse] = await Promise.all([
                    fetch(`/api/financial/BS?corp_code=${currentCorpCode}&year=${currentYear}&fs_div=${currentFsDiv}`),
                    fetch(`/api/financial/IS?corp_code=${currentCorpCode}&year=${currentYear}&fs_div=${currentFsDiv}`)
                ]);

                const [bsData, isData] = await Promise.all([
                    bsResponse.json(),
                    isResponse.json()
                ]);

                const combinedData = {
                    'BS': bsData.success ? bsData.data : {},
                    'IS': isData.success ? isData.data : {}
                };

                return combinedData;
            } catch (error) {
                console.error('재무데이터 가져오기 오류:', error);
                return {};
            }
        }

        // 유틸리티 함수들
        function showMessage(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message ${type} show`;
            
            if (type === 'info') {
                setTimeout(() => {
                    statusMessage.classList.remove('show');
                }, 3000);
            }
        }

        function showLoading(containerId) {
            const container = document.getElementById(containerId);
            container.innerHTML = `
                <div class="loading">
                    <div class="loading-spinner"></div>
                    데이터를 불러오는 중...
                </div>
            `;
        }

        function formatNumber(num) {
            return new Intl.NumberFormat('ko-KR').format(Math.round(num));
        }

        function formatAmount(amount) {
            try {
                const num = parseInt(amount);
                if (Math.abs(num) >= 1000000000000) {  // 조 단위
                    return `${(num / 1000000000000).toFixed(1)}조`;
                } else if (Math.abs(num) >= 100000000) {  // 억 단위
                    return `${(num / 100000000).toFixed(0)}억`;
                } else if (Math.abs(num) >= 10000) {  // 만 단위
                    return `${(num / 10000).toFixed(0)}만`;
                } else {
                    return `${num.toLocaleString()}`;
                }
            } catch {
                return "0";
            }
        }

        // 별도/연결 재무제표 비교 기능
        async function compareFinancialStatements() {
            if (!currentCorpCode || !currentCorpName) {
                showMessage('기업을 먼저 선택해주세요.', 'error');
                return;
            }

            try {
                showMessage('별도/연결 재무제표 데이터를 비교하고 있습니다...', 'info');
                
                // 연결재무제표와 별도재무제표 동시 조회
                const [cfsResponse, ofsResponse] = await Promise.all([
                    fetch(`/api/financial/${currentStatementType}?corp_code=${currentCorpCode}&year=${currentYear}&fs_div=CFS`),
                    fetch(`/api/financial/${currentStatementType}?corp_code=${currentCorpCode}&year=${currentYear}&fs_div=OFS`)
                ]);

                const [cfsData, ofsData] = await Promise.all([
                    cfsResponse.json(),
                    ofsResponse.json()
                ]);

                // 비교 결과 표시
                displayComparisonResult(cfsData, ofsData);
                
            } catch (error) {
                console.error('재무제표 비교 오류:', error);
                showMessage(`비교 중 오류가 발생했습니다: ${error.message}`, 'error');
            }
        }

        // 비교 결과 표시
        function displayComparisonResult(cfsData, ofsData) {
            const modalHtml = `
                <div class="comparison-modal" id="comparisonModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>📊 별도/연결 재무제표 비교 - ${currentCorpName} (${currentYear}년)</h3>
                            <button class="close-btn" onclick="closeComparisonModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div class="comparison-grid">
                                <div class="comparison-section">
                                    <h4 style="color: var(--apple-blue);">🔗 연결재무제표</h4>
                                    <p><strong>상태:</strong> ${cfsData.success ? '✅ 조회 성공' : '❌ 조회 실패'}</p>
                                    <p><strong>데이터 수:</strong> ${cfsData.success ? Object.keys(cfsData.data).length : 0}개</p>
                                    ${cfsData.success ? '' : `<p><strong>오류:</strong> ${cfsData.error || '데이터 없음'}</p>`}
                                </div>
                                <div class="comparison-section">
                                    <h4 style="color: var(--apple-orange);">🏢 별도재무제표</h4>
                                    <p><strong>상태:</strong> ${ofsData.success ? '✅ 조회 성공' : '❌ 조회 실패'}</p>
                                    <p><strong>데이터 수:</strong> ${ofsData.success ? Object.keys(ofsData.data).length : 0}개</p>
                                    ${ofsData.success ? '' : `<p><strong>오류:</strong> ${ofsData.error || '데이터 없음'}</p>`}
                                </div>
                            </div>
                            ${generateDetailedComparison(cfsData, ofsData)}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.insertAdjacentHTML('beforeend', modalHtml);
        }

        // 상세 비교 데이터 생성
        function generateDetailedComparison(cfsData, ofsData) {
            if (!cfsData.success || !ofsData.success) {
                return '<p>비교할 데이터가 충분하지 않습니다.</p>';
            }

            const cfsAccounts = Object.keys(cfsData.data);
            const ofsAccounts = Object.keys(ofsData.data);
            const commonAccounts = cfsAccounts.filter(account => ofsAccounts.includes(account));
            
            if (commonAccounts.length === 0) {
                return '<p>공통 계정과목이 없습니다.</p>';
            }

            let comparisonHtml = `
                <div class="detailed-comparison">
                    <h4>📈 주요 계정과목 비교 (상위 10개)</h4>
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>계정과목</th>
                                <th>연결재무제표</th>
                                <th>별도재무제표</th>
                                <th>차이</th>
                            </tr>
                        </thead>
                        <tbody>
            `;

            // 연결재무제표 기준으로 상위 10개 계정 비교
            const sortedAccounts = commonAccounts
                .sort((a, b) => Math.abs(cfsData.data[b]) - Math.abs(cfsData.data[a]))
                .slice(0, 10);

            sortedAccounts.forEach(account => {
                const cfsValue = cfsData.data[account];
                const ofsValue = ofsData.data[account];
                const difference = cfsValue - ofsValue;
                const isSignificantDiff = Math.abs(difference) > Math.abs(cfsValue) * 0.05; // 5% 이상 차이

                comparisonHtml += `
                    <tr ${isSignificantDiff ? 'style="background-color: #fff3cd;"' : ''}>
                        <td>${account}</td>
                        <td>${formatAmount(cfsValue)}</td>
                        <td>${formatAmount(ofsValue)}</td>
                        <td style="color: ${difference > 0 ? 'var(--apple-blue)' : difference < 0 ? 'var(--apple-red)' : 'var(--apple-dark-gray)'}">
                            ${formatAmount(difference)}
                            ${isSignificantDiff ? ' ⚠️' : ''}
                        </td>
                    </tr>
                `;
            });

            comparisonHtml += `
                        </tbody>
                    </table>
                    <p><small>⚠️ 표시: 5% 이상 차이나는 항목</small></p>
                </div>
            `;

            return comparisonHtml;
        }

        // 비교 모달 닫기
        function closeComparisonModal() {
            const modal = document.getElementById('comparisonModal');
            if (modal) {
                modal.remove();
            }
        }

        // 별도/연결 재무제표 차이 테스트
        async function testFsDifference() {
            if (!currentCorpCode || !currentCorpName) {
                showMessage('기업을 먼저 선택해주세요.', 'error');
                return;
            }

            try {
                showMessage('별도/연결 재무제표 차이를 테스트하고 있습니다...', 'info');
                
                const response = await fetch(`/api/test-fs-diff?corp_code=${currentCorpCode}&year=${currentYear}&sj_div=${currentStatementType}`);
                const data = await response.json();
                
                console.log('🧪 테스트 결과:', data);
                
                // 테스트 결과 모달 표시
                const modalHtml = `
                    <div class="comparison-modal" id="testModal">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h3>🧪 재무제표 차이 테스트 결과 - ${currentCorpName} (${currentYear}년)</h3>
                                <button class="close-btn" onclick="closeTestModal()">&times;</button>
                            </div>
                            <div class="modal-body">
                                <div class="test-results">
                                    <div class="test-section">
                                        <h4>📊 API 호출 결과</h4>
                                        <p><strong>연결재무제표 상태:</strong> ${data.cfs_status} (${data.cfs_count}개 항목)</p>
                                        <p><strong>별도재무제표 상태:</strong> ${data.ofs_status} (${data.ofs_count}개 항목)</p>
                                    </div>
                                    
                                    ${data.comparison && Object.keys(data.comparison).length > 0 ? `
                                        <div class="test-section">
                                            <h4>🔍 비교 분석</h4>
                                            <p><strong>연결 필터링 후:</strong> ${data.comparison.cfs_filtered_count}개 항목</p>
                                            <p><strong>별도 필터링 후:</strong> ${data.comparison.ofs_filtered_count}개 항목</p>
                                            <p><strong>공통 계정:</strong> ${data.comparison.common_accounts}개</p>
                                            <p><strong>차이 있는 계정:</strong> ${data.comparison.different_accounts?.length || 0}개</p>
                                            <p><strong>실제 차이 존재:</strong> ${data.comparison.has_difference ? '✅ 예' : '❌ 아니오'}</p>
                                        </div>
                                        
                                        ${data.comparison.different_accounts && data.comparison.different_accounts.length > 0 ? `
                                            <div class="test-section">
                                                <h4>💰 차이가 있는 계정 (상위 5개)</h4>
                                                <table class="comparison-table">
                                                    <thead>
                                                        <tr>
                                                            <th>계정과목</th>
                                                            <th>연결재무제표</th>
                                                            <th>별도재무제표</th>
                                                            <th>차이</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        ${data.comparison.different_accounts.slice(0, 5).map(item => `
                                                            <tr>
                                                                <td>${item.account}</td>
                                                                <td>${formatAmount(item.cfs_amount)}</td>
                                                                <td>${formatAmount(item.ofs_amount)}</td>
                                                                <td style="color: ${item.difference > 0 ? 'var(--apple-blue)' : 'var(--apple-red)'}">
                                                                    ${formatAmount(item.difference)}
                                                                </td>
                                                            </tr>
                                                        `).join('')}
                                                    </tbody>
                                                </table>
                                            </div>
                                        ` : ''}
                                    ` : '<p>비교 데이터가 없습니다.</p>'}
                                    
                                    <div class="test-section">
                                        <h4>💡 결론</h4>
                                        ${data.comparison?.has_difference ? 
                                            '<p style="color: var(--apple-green);"><strong>✅ 별도/연결 재무제표에 실제 차이가 있습니다!</strong></p>' :
                                            '<p style="color: var(--apple-red);"><strong>⚠️ 별도/연결 재무제표 데이터에 차이가 없습니다.</strong><br>이는 다음 이유일 수 있습니다:<br>1. 해당 기업이 연결대상 자회사가 없음<br>2. DART API에서 동일한 데이터 반환<br>3. 해당 년도/보고서에 별도재무제표가 없음</p>'
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.insertAdjacentHTML('beforeend', modalHtml);
                
                showMessage(data.comparison?.has_difference ? 
                    '차이 테스트 완료: 실제 차이가 발견되었습니다!' : 
                    '차이 테스트 완료: 차이가 발견되지 않았습니다.', 
                    data.comparison?.has_difference ? 'success' : 'warning'
                );
                
            } catch (error) {
                console.error('차이 테스트 오류:', error);
                showMessage(`차이 테스트 오류: ${error.message}`, 'error');
            }
        }

        // 테스트 모달 닫기
        function closeTestModal() {
            const modal = document.getElementById('testModal');
            if (modal) {
                modal.remove();
            }
        }
    </script>
</body>
</html> 